import cv2
import pytesseract
import pandas as pd
import re
import os
from glob import glob

# === CONFIG ===
INPUT_FOLDER = "images"        # put all JPG/PNG files here
OUTPUT_FILE = "output.xlsx"

# === 1. Load and preprocess image ===
def preprocess_image(path):
    img = cv2.imread(path)
    gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
    gray = cv2.threshold(gray, 0, 255, cv2.THRESH_BINARY | cv2.THRESH_OTSU)[1]
    return gray

# === 2. Extract text with Tesseract OCR ===
def extract_text(image):
    config = r'--oem 3 --psm 6'
    return pytesseract.image_to_string(image, config=config)

# === 3. Parse text into table (Tanggal, Keterangan, Debet, Kredit) ===
def parse_text(text, filename):
    rows = []
    last_date = ""  # remember last date for continuation rows

    for line in text.splitlines():
        if not line.strip():
            continue

        # Normalize spaces
        line = re.sub(r"\s+", " ", line.strip())

        # Match columns: date, description, debit, credit
        match = re.match(r"(\d{1,2}/\d{1,2})?\s*(.*?)\s+([\d.,]+)?\s*(\(.*\))?", line)
        if match:
            tanggal = match.group(1) if match.group(1) else last_date
            keterangan = match.group(2).strip()
            debet = match.group(3) if match.group(3) else ""
            kredit = match.group(4).replace("(", "").replace(")", "") if match.group(4) else ""

            if tanggal:  # update last_date when a new date appears
                last_date = tanggal

            rows.append([tanggal, keterangan, debet, kredit, os.path.basename(filename)])

    return rows

# === 4. Save results to Excel ===
def save_to_excel(rows, filename):
    df = pd.DataFrame(rows, columns=["Tanggal", "Keterangan", "Debet", "Kredit", "Source File"])
    df.to_excel(filename, index=False)
    print(f"‚úÖ Saved to {filename} with {len(df)} rows")

# === MAIN ===
if __name__ == "__main__":
    all_rows = []
    files = glob(os.path.join(INPUT_FOLDER, "*.jpg")) + glob(os.path.join(INPUT_FOLDER, "*.png"))

    if not files:
        print(f"‚ùå No images found in {INPUT_FOLDER}/")
    else:
        print(f"üìÇ Found {len(files)} image(s) in {INPUT_FOLDER}/")

        for file in files:
            print(f"üîé Processing {file} ...")
            gray_img = preprocess_image(file)
            text = extract_text(gray_img)
            rows = parse_text(text, file)
            all_rows.extend(rows)

        if all_rows:
            save_to_excel(all_rows, OUTPUT_FILE)
        else:
            print("‚ö†Ô∏è No rows extracted from images.")
