<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Excel Upload & Process</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <h2>Upload Excel File</h2>
  <input type="file" id="upload" accept=".xlsx,.xls" />

  <h2>Data Preview</h2>
  <table id="dataTable" border="1" style="border-collapse:collapse; margin-top:10px;">
    <thead></thead>
    <tbody></tbody>
  </table>

  <br>
  <button id="processBtn">Process Selected</button>
  <span id="statusMsg" style="margin-left:10px; font-weight:bold; color:#0066cc;"></span>

  <script>
    let uploadedData = [];

    // Handle Excel upload
    document.getElementById("upload").addEventListener("change", function(e) {
      let file = e.target.files[0];
      if (!file) return;

      let reader = new FileReader();
      reader.onload = function(e) {
        let data = new Uint8Array(e.target.result);
        let workbook = XLSX.read(data, { type: "array" });

        let sheetName = workbook.SheetNames[0];
        let sheet = workbook.Sheets[sheetName];
        uploadedData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        renderTable(uploadedData);
      };
      reader.readAsArrayBuffer(file);
    });

    // Render table with checkboxes
    function renderTable(data) {
      let tableHead = document.querySelector("#dataTable thead");
      let tableBody = document.querySelector("#dataTable tbody");
      tableHead.innerHTML = "";
      tableBody.innerHTML = "";

      if (data.length === 0) return;

      // Header row
      let headerRow = "<tr><th><input type='checkbox' id='selectAll'></th>";
      data[0].forEach(col => {
        headerRow += `<th>${col}</th>`;
      });
      headerRow += "</tr>";
      tableHead.innerHTML = headerRow;

      // Data rows
      for (let i = 1; i < data.length; i++) {
        let row = `<tr><td><input type='checkbox' class='rowCheckbox'></td>`;
        data[i].forEach(cell => {
          row += `<td>${cell !== undefined ? cell : ""}</td>`;
        });
        row += "</tr>";
        tableBody.innerHTML += row;
      }

      // Handle Select All
      document.getElementById("selectAll").addEventListener("change", function() {
        let checkboxes = document.querySelectorAll(".rowCheckbox");
        checkboxes.forEach(cb => cb.checked = this.checked);
      });
    }

    // Process selected rows
    document.getElementById("processBtn").addEventListener("click", function() {
      let btn = this;
      let status = document.getElementById("statusMsg");

      let selectedRows = [];
      let checkboxes = document.querySelectorAll(".rowCheckbox");

      checkboxes.forEach((cb, index) => {
        if (cb.checked) {
          selectedRows.push(uploadedData[index + 1]); // +1 because row[0] = header
        }
      });

      if (selectedRows.length === 0) {
        alert("No rows selected!");
        return;
      }

      // Show processing
      btn.disabled = true;
      status.innerHTML = "⏳ Processing...";

      // Simulate processing delay
      setTimeout(() => {
        // Export selected rows to Excel
        let newData = [uploadedData[0], ...selectedRows]; // Keep header row
        let worksheet = XLSX.utils.aoa_to_sheet(newData);
        let newWorkbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(newWorkbook, worksheet, "Processed");
        XLSX.writeFile(newWorkbook, "processed.xlsx");

        status.innerHTML = "✅ Completed! File downloaded.";
        btn.disabled = false;
      }, 2000);
    });
  </script>
</body>
</html>
