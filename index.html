<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Florista Sekar — Receipt OCR → Excel</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { color: #c2185b; }
    #rawOutput { width: 100%; height: 200px; border: 1px solid #ccc; padding: 8px; overflow-y: auto; background: #f9f9f9; white-space: pre-wrap; }
    table { border-collapse: collapse; margin-top: 10px; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; }
    input { margin-top: 10px; }
  </style>
</head>
<body>
  <h2>Florista Sekar — Receipt OCR → Excel</h2>
  <input type="file" id="fileInput" accept="image/*">
  <button id="processBtn">Process Selected</button>
  <button id="parseBtn">Parse to Table</button>
  <button id="downloadBtn">Download Excel</button>
  <button id="clearBtn">Clear All</button>

  <h3>Raw OCR output (from JPG/PNG)</h3>
  <div id="rawOutput">-</div>

  <h3>Parsed rows</h3>
  <table id="dataTable">
    <thead></thead>
    <tbody></tbody>
  </table>

  <script>
    let parsedData = [];
    let ocrText = "";

    // Step 1: Run OCR
    document.getElementById("processBtn").addEventListener("click", function() {
      let file = document.getElementById("fileInput").files[0];
      if (!file) {
        alert("Please select an image first.");
        return;
      }

      document.getElementById("rawOutput").innerText = "⏳ Running OCR...";

      Tesseract.recognize(file, 'eng').then(({ data: { text } }) => {
        ocrText = text;
        document.getElementById("rawOutput").innerText = text;
        alert("✅ OCR finished. Check Raw OCR output box.");
      });
    });

    // Step 2: Parse OCR text into table (basic version)
    document.getElementById("parseBtn").addEventListener("click", function() {
      if (!ocrText) {
        alert("No OCR text available. Run Process Selected first.");
        return;
      }

      let lines = ocrText.split("\n").filter(l => l.trim() !== "");
      parsedData = lines.map(line => line.split(/\s+/)); // split by whitespace
      renderTable(parsedData);
    });

    function renderTable(data) {
      let tableHead = document.querySelector("#dataTable thead");
      let tableBody = document.querySelector("#dataTable tbody");
      tableHead.innerHTML = "";
      tableBody.innerHTML = "";

      if (data.length === 0) return;

      let maxCols = Math.max(...data.map(row => row.length));
      let headerRow = "<tr>";
      for (let i = 0; i < maxCols; i++) {
        headerRow += `<th>Col ${i+1}</th>`;
      }
      headerRow += "</tr>";
      tableHead.innerHTML = headerRow;

      data.forEach(row => {
        let tr = "<tr>";
        for (let i = 0; i < maxCols; i++) {
          tr += `<td contenteditable="true">${row[i] || ""}</td>`;
        }
        tr += "</tr>";
        tableBody.innerHTML += tr;
      });
    }

    // Step 3: Download Excel
    document.getElementById("downloadBtn").addEventListener("click", function() {
      if (parsedData.length === 0) {
        alert("No data to export.");
        return;
      }

      let table = [];
      document.querySelectorAll("#dataTable tbody tr").forEach(tr => {
        let row = [];
        tr.querySelectorAll("td").forEach(td => row.push(td.innerText));
        table.push(row);
      });

      let worksheet = XLSX.utils.aoa_to_sheet(table);
      let wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, worksheet, "OCR_Data");
      XLSX.writeFile(wb, "receipt_data.xlsx");
    });

    // Step 4: Clear everything
    document.getElementById("clearBtn").addEventListener("click", function() {
      document.getElementById("rawOutput").innerText = "-";
      document.querySelector("#dataTable thead").innerHTML = "";
      document.querySelector("#dataTable tbody").innerHTML = "";
      parsedData = [];
      ocrText = "";
    });
  </script>
</body>
</html>
