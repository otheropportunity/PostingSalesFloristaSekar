<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Florista Sekar — Receipt OCR → Excel</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    h2 { color: #b30059; }
    button { margin: 5px; padding: 8px 14px; border: none; border-radius: 5px; cursor: pointer; }
    #process { background: #007bff; color: white; }
    #download { background: #28a745; color: white; }
    #clear { background: #dc3545; color: white; }
    table { margin: 20px auto; border-collapse: collapse; width: 90%; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background: #f2f2f2; }
    pre { text-align: left; max-height: 200px; overflow: auto; background: #f9f9f9; padding: 10px; }
  </style>
</head>
<body>
  <h2>Florista Sekar — Receipt OCR → Excel</h2>

  <input type="file" id="fileInput" multiple accept="image/*">
  <br><br>
  <button id="process">Process Selected</button>
  <button id="download">Download Excel</button>
  <button id="clear">Clear All</button>

  <h3>Raw OCR Output</h3>
  <pre id="ocrOutput">-</pre>

  <h3>Parsed Rows</h3>
  <table id="resultTable">
    <thead>
      <tr><th>Tanggal</th><th>Keterangan</th><th>Debit</th><th>Kredit</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let allRows = [];

    // Helper: parse OCR text into structured rows
    function parseText(text) {
      const rows = [];
      const lines = text.split("\n").map(l => l.trim()).filter(l => l);

      let lastDate = "";
      const regex = /^(\d{1,2}\/\d{1,2})?\s*(.+?)\s+([\d.]+)?\s*(\(\w+\))?$/;

      for (let line of lines) {
        const match = line.match(regex);
        if (match) {
          const tanggal = match[1] ? match[1] : lastDate;
          if (match[1]) lastDate = match[1];
          const ket = match[2];
          const debit = match[3] || "";
          const kredit = match[4] || "";
          rows.push([tanggal, ket, debit, kredit]);
        }
      }
      return rows;
    }

    // Process images
    document.getElementById("process").onclick = async () => {
      const files = document.getElementById("fileInput").files;
      if (!files.length) {
        alert("Please select at least one image.");
        return;
      }

      document.getElementById("ocrOutput").textContent = "Processing...";

      allRows = [];
      for (let file of files) {
        const { data: { text } } = await Tesseract.recognize(file, 'eng');
        document.getElementById("ocrOutput").textContent = text;
        const rows = parseText(text);
        allRows.push(...rows);
      }

      // Fill table
      const tbody = document.querySelector("#resultTable tbody");
      tbody.innerHTML = "";
      allRows.forEach(r => {
        const tr = document.createElement("tr");
        r.forEach(cell => {
          const td = document.createElement("td");
          td.textContent = cell;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    };

    // Download Excel
    document.getElementById("download").onclick = () => {
      if (!allRows.length) {
        alert("No data to download!");
        return;
      }
      const ws = XLSX.utils.aoa_to_sheet([["Tanggal","Keterangan","Debit","Kredit"], ...allRows]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Receipts");
      XLSX.writeFile(wb, "Florista_Sekar.xlsx");
    };

    // Clear everything
    document.getElementById("clear").onclick = () => {
      document.getElementById("ocrOutput").textContent = "-";
      document.querySelector("#resultTable tbody").innerHTML = "";
      allRows = [];
    };
  </script>
</body>
</html>
